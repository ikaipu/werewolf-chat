# 非アクティブルームの自動削除仕様書

## 機能概要
チャットルームの自動管理機能の一部として、一定期間アクティビティのないルームを自動的に削除する機能です。
システムリソースの効率的な管理とユーザーエクスペリエンスの向上を目的としています。

## 処理フロー
```
+----------------------------------------+
|           定期実行トリガー              |
|           (毎日午前0時)                 |
|                 ↓                       |
|    +-------------------------+          |
|    | 非アクティブルーム検出  |          |
|    | (3日以上無活動)        |          |
|    +-------------------------+          |
|                 ↓                       |
|    +-------------------------+          |
|    | サブコレクション削除    |          |
|    | - messages             |          |
|    | - participants         |          |
|    +-------------------------+          |
|                 ↓                       |
|    +-------------------------+          |
|    | ルームドキュメント削除  |          |
|    +-------------------------+          |
|                 ↓                       |
|           処理完了ログ                  |
+----------------------------------------+
```

## 機能要素
1. アクティビティ監視
   - ルーム作成時の初期設定
   - メッセージ送信時の更新
   - 参加者入室時の更新
   - 最終アクティビティのタイムスタンプ管理

2. 自動削除処理
   - 実行間隔: 24時間ごと（毎日午前0時）
   - 対象: 3日以上アクティビティのないルーム
   - 削除順序: サブコレクション → ルームドキュメント

3. ログ記録
   - 削除実行の開始・完了
   - 削除されたルーム数
   - エラー発生時の詳細情報

## エラーハンドリング
- 削除処理の途中失敗: 次回の実行時に再試行
- サブコレクション削除エラー: 個別にログを記録し処理継続
- システムエラー: Cloud Functionsログに詳細を記録

## システム要件
- 実行環境: Firebase Cloud Functions
- Node.jsランタイム: v22
- リージョン: asia-northeast1
- タイムアウト設定: 9分
- メモリ割り当て: デフォルト値を使用

## データ構造
```typescript
interface Room {
  name: string;
  createdAt: Timestamp;
  lastActivity: Timestamp;  // アクティビティ追跡用
  // その他のフィールド
}
```

## その他の注意点
1. ユーザーへの通知
   - 削除は自動的に実行され、特別な通知は行わない
   - ルーム作成時にヘルプテキストで非アクティブルームの削除ポリシーを表示

2. パフォーマンス考慮事項
   - 大量のドキュメント削除時のFirestore負荷を考慮
   - バッチ処理でのドキュメント削除を実装

3. データ保護
   - 削除前のデータバックアップは行わない
   - 一度削除されたルームは復元不可

4. 監視とメンテナンス
   - Cloud Functionsのログで定期的に実行状況を確認
   - エラーレートの監視と必要に応じた調整